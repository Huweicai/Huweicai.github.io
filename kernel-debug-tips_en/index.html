<!DOCTYPE html>
<html lang="zn-Hans">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1" />
  <meta name="author" content="Huweicai">
  <meta name="description" content="Kernel Kernel undertakes the core Operating System job, which is the foundation of the current software ecosystem.
So, knowing more about how the kernel works will contribute to the construction of our user mode system.
The best method to learn software code is debugging while watching, software = code &#43; data, know more about the runtime data while learning code can help us understand it better.
However the Kernel is not a normal software system, we can&rsquo;t add breakpoint and debug it through IDE debug button like other normal software, though we can implement it by kgdb &#43; QEMU, it&rsquo; still too heavy, and not available for online systems.
This article shares two lightweight kernel debugging tips, helps us observing it runtime status rapidly.
Kernel Module Usally, our codes are runing in user mode. In Linux operating systems, the instruction of user mode program will run in level Ring 3 , they do not have the permission to acces the data in level Ring 0 high memory address space, which means that they can&rsquo;t snoop the data inside Kernel.
In that case, why not try to run our code inside the Kernel?
It&rsquo;s possible to edit the source code of kernel, adding log to print the information we concerned, but it&rsquo;s a long tedious step.">

  <meta property="og:title" content="Linux Kernel Debug Tips" />
<meta property="og:description" content="Kernel Kernel undertakes the core Operating System job, which is the foundation of the current software ecosystem.
So, knowing more about how the kernel works will contribute to the construction of our user mode system.
The best method to learn software code is debugging while watching, software = code &#43; data, know more about the runtime data while learning code can help us understand it better.
However the Kernel is not a normal software system, we can&rsquo;t add breakpoint and debug it through IDE debug button like other normal software, though we can implement it by kgdb &#43; QEMU, it&rsquo; still too heavy, and not available for online systems.
This article shares two lightweight kernel debugging tips, helps us observing it runtime status rapidly.
Kernel Module Usally, our codes are runing in user mode. In Linux operating systems, the instruction of user mode program will run in level Ring 3 , they do not have the permission to acces the data in level Ring 0 high memory address space, which means that they can&rsquo;t snoop the data inside Kernel.
In that case, why not try to run our code inside the Kernel?
It&rsquo;s possible to edit the source code of kernel, adding log to print the information we concerned, but it&rsquo;s a long tedious step." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huweicai.com/kernel-debug-tips_en/" /><meta property="article:section" content="" />
<meta property="article:published_time" content="2023-01-17T00:00:00+08:00" />
<meta property="article:modified_time" content="2023-01-17T00:00:00+08:00" />


   









  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-175035126-1');
    window.addEventListener('load', function(){
      var s = document.createElement('script');
      s.src = "https://www.googletagmanager.com/gtag/js?id=UA-175035126-1";
      document.body.appendChild(s);
    });
  </script>

  <title>
  
       Linux Kernel Debug Tips | Anonymous&#39; Blog 
  
  </title>

  <link rel="canonical" href="https://huweicai.com/kernel-debug-tips_en/">

  
  

  
  <link href="https://huweicai.com/css/vendors-extensions/fontawesome/all.min.css" rel="stylesheet">

  
  <link href="https://huweicai.com/css/font.css" rel="stylesheet">

  
  <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/mdbootstrap/4.9.0/css/mdb.min.css" rel="stylesheet">
  <link href="https://huweicai.com/css/vendors/mdb/style.min.css" rel="stylesheet">
  <link href="https://huweicai.com/css/main.css" rel="stylesheet">


  
  <link rel="shortcut icon"
  
      href="https://huweicai.com/img/profile.svg"
  
  >


  <link href="" rel="alternate" type="application/rss+xml" title="Anonymous&#39; Blog" />

  <style type="text/css">
      @media (min-width: 800px) and (max-width: 850px) {
              .navbar:not(.top-nav-collapse) {
                  background: #000000!important;
              }
          }
  </style>


  
  
    <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.13.0/katex.min.css">
  
  

  
  
    <link rel="stylesheet" href="https://huweicai.com/css/vendors/highlight/github-gist.css">
  

</head>

  <body class="bg-light" data-spy="scroll" data-target="#page-scrollspy" data-offset="90">
  
    
    

    
      


<nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <div class="container">

      
      <a class="navbar-brand" href="https://huweicai.com">
          
        <img class="avatar imgRotate" src="https://huweicai.com/img/profile.svg" style="width: 40px!important;height: auto;"  class="d-inline-block align-top" alt="" >
        
        <strong> Huweicai</strong>
      </a>

      
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      
      <div class="collapse navbar-collapse" id="navbarSupportedContent">

        
        <ul class="navbar-nav mr-auto ">
          <li class="nav-item ">
            <a class="nav-link" href="https://huweicai.com">Home</a>
          </li>
             
            <li class="nav-item ">
              <a class="nav-link" href="https://huweicai.com/about/" >About  </a>
            </li>
          
             
            <li class="nav-item ">
              <a class="nav-link" href="https://huweicai.com/archives/" >Archives  </a>
            </li>
          
          
        </ul>

      </div>

    </div>
  </nav>
  
 
      
 






<div id="site-header" class="carousel slide carousel-fade" data-ride="carousel" style="height: 18rem;" >  

  
  
  

  
  <div class="carousel-inner" role="listbox">
    
      

        
        <div class="carousel-item active">
          <div class="view" style="background-image: url('https://huweicai.com/img/header-slides/core.png'); background-repeat: no-repeat; background-size: cover;">

            
            <div class="mask rgba-black-light d-flex justify-content-center align-items-center">

              
              
              

            </div>
            

          </div>
        </div>
        
      
    

  
  </div>
  

  
  <div class="carousel-content text-center white-text wow fadeIn">
    <div class="row mx-0 headfont mt-3 pt-4">
      
      <div class="col-12 col-sm-5 align-middle">
        <a href="https://huweicai.com">
          
            <img class="pull-right avatar avatar-md imgRotate" src="https://huweicai.com/img/profile.svg" alt="" >
          
        </a>
      </div>
      
      <div class="col-12 col-sm-7 text-left pl-2">
        <a href="https://huweicai.com">
          <h1 class="mb-2 h1" style="font-weight: 300;" >
            <strong>Anonymous&#39; Blog</strong>
          </h1>
        </a>
        

             
        <div class="mt-2" style="font-size: 1rem; color: white;">
            
              <a href="//github.com/Huweicai" target="_blank" rel="noopener"><i class="fab fa-github pr-1" aria-hidden="true"></i></a>    
            
            
              <a href="//linkedin.com/in/you" target="_blank" rel="noopener"><i class="fab fa-linkedin pr-1" aria-hidden="true"></i></a>
            

            
              <a href="//facebook.com/you" target="_blank" rel="noopener"><i class="fab fa-facebook pr-1" aria-hidden="true"></i></a>
            

            
            <a href="//google.com/you" target="_blank" rel="noopener"><i class="fab fa-google-plus pr-1" aria-hidden="true"></i></a>
            

            
                <a href="//twitter.com/you" target="_blank" rel="noopener"><i class="fab fa-twitter pr-1" aria-hidden="true"></i></a>
            

            
                <a href="//instagram.com/you" target="_blank" rel="noopener"><i class="fab fa-instagram pr-1" aria-hidden="true"></i></a>
            
    
            
                <a href="//px500" target="_blank" rel="noopener"><i class="fab fa-500px pr-1" aria-hidden="true"></i></a>
            
    
        
            
                <a href="mailto:i@huweicai.com"><i class="far fa-envelope-open pr-1" aria-hidden="true"></i></a>
            
    
                <a href=""><i class="fas fa-rss pr-1" aria-hidden="true"></i></a>

            
        </div>
      </div>
    </div>
  </div>
  

  
  
  

</div>
  
    

    
  
  <main class="post-main-wrapper">
    
    
    <div class="row">

      

      
      <div class="col-md-10">
      

        
        <div class="z-depth-1  post-wrapper white-bg single-post">

          <div class="post-header text-center">
    <ul class="post-meta li-x">
        
            
                <li><a href="https://huweicai.com/categories/english"><i class="fas fa-folder-open pr-1"
                                                                                  aria-hidden="true"></i> english </a>
                </li>
            
        
        
    </ul>

    <div class="px-4 post-heading">Linux Kernel Debug Tips</div>

    <ul class="post-meta li-x mt-1">
        
            <li>2023-01-17</li>
        

        
            <li class="middot"></li>
            <li>9 minutes read</li>
        
        <li>1723 words</li>

    </ul>
    

</div>


          <div class="post-content markdown">
            <h1 id="kernel">Kernel</h1>
<p>Kernel undertakes the core Operating System job, which is the foundation of the current software ecosystem.</p>
<p>So, knowing more about how the kernel works will contribute to the construction of our user mode system.</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huweicai/images/20210625150645.png" alt="image-20210625150638408"></p>
<p>The best method to learn software code is debugging while watching, software = code + data, know more about the runtime data while learning code can help us understand it better.</p>
<p>However the Kernel is not a normal software system, we can&rsquo;t add breakpoint and debug it through IDE debug button like other normal software, though we can implement it by kgdb + QEMU, it&rsquo; still too heavy, and not available for online systems.</p>
<p>This article shares two lightweight kernel debugging tips, helps us observing it runtime status rapidly.</p>
<h1 id="kernel-module">Kernel Module</h1>
<p>Usally, our codes are runing in user mode. In Linux operating systems, the instruction of user mode program will run in level <code>Ring 3</code> , they do not have the permission to acces the data in level <code>Ring 0</code> high memory address space, which means that they can&rsquo;t snoop the data inside Kernel.</p>
<p>In that case, why not try to run our code inside the Kernel?</p>
<p>It&rsquo;s possible to edit the source code of kernel, adding log to print the information we concerned, but it&rsquo;s a long tedious step.</p>
<p>Macro kernel architecture Linux provides hot-swappable modular extension mechanism, we can develop a kernel module, in which we can read and print the insterested variables, without compile and reload the whole operating system.</p>
<p>For example, the datastructure of each program progress inside kernel is <code>task_struct</code>, we can find <a href="https://elixir.bootlin.com/linux/v5.13/source/include/linux/sched.h#L657">it&rsquo;s definition</a> in kernel source code easily, however, what&rsquo;s the actual value of those fields in definition while program running in different situation ?</p>
<p>Let&rsquo;s implement a kernel module to find out what it looks like.</p>
<p>It&rsquo;s very easy to develop a kernel module, we only need to implement two functions, one for initialization and another for clean up, the complete module developing tutorial we can refer to this document: <a href="https://tldp.org/LDP/lkmpg/2.6/lkmpg.pdf">https://tldp.org/LDP/lkmpg/2.6/lkmpg.pdf</a>.</p>
<p>First of all, we should write the module code as below, and save it to file <code>kdebugger.c</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// we have to reference the kernel header file, since the standard lib is not avaiable here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched/signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">test_tasks_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">process_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">current_task</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// printk is the alternative for printf inside kernel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pr_info</span><span class="p">(</span><span class="s">&#34;%s: In init</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">current_task</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_task</span><span class="p">;</span> <span class="p">(</span><span class="n">current_task</span> <span class="o">=</span> <span class="n">next_task</span><span class="p">(</span><span class="n">current_task</span><span class="p">))</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">init_task</span><span class="p">;</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">pr_info</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Command: %s PID: %d TGID: %d State: %ld Flags: %d Policy: %d Prio: %d StaticPrio: %d Current CPU: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">static_prio</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_task</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">process_count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="n">pr_info</span><span class="p">(</span><span class="s">&#34;Number of processes:%u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">process_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">test_tasks_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pr_info</span><span class="p">(</span><span class="s">&#34;%s: In exit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// declare the LICENSE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// indicate which function will do the init and exit job
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">module_init</span><span class="p">(</span><span class="n">test_tasks_init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">module_exit</span><span class="p">(</span><span class="n">test_tasks_exit</span><span class="p">);</span>
</span></span></code></pre></div><p>And then write the <code>Makefile</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">+=</span> kdebugger.o
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build -I /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/source/include <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	make -C /lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean
</span></span></code></pre></div><p>Now the code part was finished, but before compilation we have to install some dependencies: <code>gcc</code> and kernel header files.</p>
<p>Most linux distributions will have <code>gcc</code>pre-installed, but the version are always too old, the newer versions kernel will have greater requirement of <code>gcc</code>, so it will be better to upgrade the <code>gcc</code> to newer version, take <code>CentOS</code> for example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum install devtoolset-8-gcc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># uninstall the old gcc and add new gcc to PATH</span>
</span></span><span class="line"><span class="cl">/opt/rh/devtoolset-8/root/usr/bin/gcc
</span></span></code></pre></div><p>Kernel header files are also essential, otherwise the compilation will fail.</p>
<p>We can install it using <code>yum</code> directly, but remember to check the header files version whether match the kernel version,</p>
<p>unlike interfaces exposed to user mode, datastructure and functions can be totally different between versions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum install kernel-headers
</span></span></code></pre></div><p>After solved the dependency problem, we can start compilation now, just run <code>make</code>in current directory, and then we will find a <code>kdebugger.ko</code> （<code>.ko</code>file format is the kernel version  <code>.o</code> ）file generated, this is the kernel module we wanted.</p>
<p>Next we can execute <code>insmod kdebugger.ko</code> to install the module into kernel, and we can list the kernel modules to see whether it added, as expected, kdebugger showed in the first line:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@dev# cat /proc/modules
</span></span><span class="line"><span class="cl">kdebugger <span class="m">16384</span> <span class="m">0</span> - Live 0xffffffffc0808000 <span class="o">(</span>O<span class="o">)</span>
</span></span><span class="line"><span class="cl">xt_statistic <span class="m">16384</span> <span class="m">3</span> - Live 0xffffffffc07fe000
</span></span><span class="line"><span class="cl">ip6table_mangle <span class="m">16384</span> <span class="m">0</span> - Live 0xffffffffc06b2000
</span></span><span class="line"><span class="cl">ip6table_filter <span class="m">16384</span> <span class="m">0</span> - Live 0xffffffffc06ad000
</span></span><span class="line"><span class="cl">nf_tables <span class="m">204800</span> <span class="m">0</span> - Live 0xffffffffc07a7000
</span></span><span class="line"><span class="cl">nfnetlink_queue <span class="m">24576</span> <span class="m">0</span> - Live 0xffffffffc06f8000
</span></span><span class="line"><span class="cl">nfnetlink_log <span class="m">20480</span> <span class="m">0</span> - Live 0xffffffffc06ca000
</span></span><span class="line"><span class="cl">bluetooth <span class="m">606208</span> <span class="m">0</span> - Live 0xffffffffc0712000
</span></span><span class="line"><span class="cl">ecdh_generic <span class="m">16384</span> <span class="m">1</span> bluetooth, Live 0xffffffffc06f3000
</span></span><span class="line"><span class="cl">....
</span></span></code></pre></div><p>Kernel will call the <strong>init</strong> function of the module while installing, which is the <code>test_tasks_init</code> function is our above debug code, <code>printk</code> will send the output to kernel Ring Buffer, we can check it by <code>dmesg</code> command, and the information we concerned will shows up:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@dev# demesg -TL
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl"><span class="o">[</span>Sun Mar <span class="m">14</span> 18:25:52 2022<span class="o">]</span> test_tasks_exit: In <span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Sun Mar <span class="m">14</span> 18:25:52 2022<span class="o">]</span> test_tasks_init: In init
</span></span><span class="line"><span class="cl"><span class="o">[</span>Sun Mar <span class="m">14</span> 18:25:52 2022<span class="o">]</span>
</span></span><span class="line"><span class="cl">Command: systemd PID: <span class="m">1</span> TGID: <span class="m">1</span> State: <span class="m">1</span> Flags: <span class="m">4194560</span> Policy: <span class="m">0</span> Prio: <span class="m">120</span> StaticPrio: <span class="m">120</span> Current CPU: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Sun Mar <span class="m">14</span> 18:25:52 2022<span class="o">]</span>
</span></span><span class="line"><span class="cl">Command: kthreadd PID: <span class="m">2</span> TGID: <span class="m">2</span> State: <span class="m">1</span> Flags: <span class="m">2129984</span> Policy: <span class="m">0</span> Prio: <span class="m">120</span> StaticPrio: <span class="m">120</span> Current CPU: <span class="m">1</span>
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl"><span class="o">[</span>Mon Mar <span class="m">14</span> 17:30:40 2022<span class="o">]</span> Number of processes:197
</span></span></code></pre></div><p>One last tip, be sure to be careful to write kernel module, debug it in virtual machine first,  any minor oversight may causing the entire operating system to crash.</p>
<h1 id="ebpf">eBPF</h1>
<h2 id="ebpf-1">eBPF</h2>
<p>To run our code with privilege Ring 0 in kernel mode, kernel provides another cool extention solution, except the kernel module mentioned above —— eBPF.</p>
<p><code>eBPF </code>can be unterstood as a simple VM inside kernel, we can commit some basic instructions to kernel to run. Though there many limitations of <code>eBPF</code>, such as limited number of instructions, limited number of program cycles, run time, stack size and bytecode size are all restricted, and there are only some numbered kernel API exposed to <code>eBPF</code> instruction, though there are so many shackle <code>eBPF</code>is still an amzing and practical technology, and such hard limitation could actually free us, protect us from the momentary OS crash.</p>
<p>What&rsquo; more, <code>eBPF</code> is more lightweight and safe comparing to wirte kernel module directlly.</p>
<p>There are many famous application are implemented base on <code>eBPF</code>, such as network plugin <code>Cilium</code>, safety detection application <code>Faloc</code>, observation enhanced application <code>Pixie</code> , and so on.</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huweicai/images/20221129114451.png" alt="img"></p>
<p>eBPF programs are event driven model, which means we can insert many callback functions into kernel.</p>
<p>Kernel provided many hook points, we can declare eBPF program to register to specifi hook point, when corresponding event happends our code will be called.</p>
<p>The supported eBPF program types enum can be found here:  <a href="https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L908">https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L908</a>。</p>
<h2 id="bpftrace">bpftrace</h2>
<p>Editing and compiling  eBPF C code, and then commit it to kernel to run is still a complex procedure, which is not too much simple than just compiling kernel module.</p>
<p>But we have more convenient tool: <a href="https://github.com/iovisor/bpftrace">bpftrace</a>, a lightweight eBPF program execution framework, or a more simple to run and learn dialect of eBPF.</p>
<p>We can install bpftrace by package manager directlly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># RPM</span>
</span></span><span class="line"><span class="cl">curl https://repos.baslab.org/rhel/7/bpftools/bpftools.repo --output /etc/yum.repos.d/bpftools.repo
</span></span><span class="line"><span class="cl">yum install bpftrace bpftrace-tools bpftrace-doc bcc-static bcc-tools
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># APT</span>
</span></span><span class="line"><span class="cl">apt install bpftrace
</span></span></code></pre></div><p>The various hook points we mentioned above are abstracted as a concept of &lsquo;probe&rsquo; in bpfprobe, all the probes supported can be inspected by <code>-l</code> argument:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@dev# bpftrace -l
</span></span><span class="line"><span class="cl">hardware:backend-stalls:
</span></span><span class="line"><span class="cl">hardware:instructions:
</span></span><span class="line"><span class="cl">hardware:ref-cycles:
</span></span><span class="line"><span class="cl">iter:task
</span></span><span class="line"><span class="cl">iter:task_file
</span></span><span class="line"><span class="cl">kprobe:FSE_NCountWriteBound
</span></span><span class="line"><span class="cl">kprobe:FSE_buildCTable_wksp
</span></span><span class="line"><span class="cl">kprobe:FSE_buildDTable_raw
</span></span><span class="line"><span class="cl">tracepoint:xhci-hcd:xhci_stop_device
</span></span><span class="line"><span class="cl">tracepoint:xhci-hcd:xhci_urb_dequeue
</span></span><span class="line"><span class="cl">tracepoint:xhci-hcd:xhci_urb_enqueue
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>bpftrace script are consisted of three part: <code>probe /filter/ { action }</code>,  <strong>probe</strong> defines one or more hook points, when corresponding events happend and meet the condition declared in <strong>filter</strong>, the code inside <strong>action</strong> will be executed.</p>
<p>The complete program syntax can be found in it&rsquo;s official site:  <a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md</a>.</p>
<h2 id="have-a-try">Have a try</h2>
<p>As for the demand of analyzing struct <code>task_struct</code>, it can be implemented by bpftrace with ease.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># traverse all task</span>
</span></span><span class="line"><span class="cl">bpftrace -e <span class="s1">&#39;iter:task { printf(&#34;%s:%d\n&#34;, ctx-&gt;task-&gt;comm, ctx-&gt;task-&gt;pid); }&#39;</span>
</span></span></code></pre></div><p>However the <code>iter</code> probe mentioned in above code is implemented base on eBPF program type <code>TRACING</code>, which requires kernel version <code>5.5</code>at least as well as the enable of BTF feature, it can be a little hard.</p>
<p>There&rsquo;s an alternative probe called <code>kprobe</code>, which can let us insert callback some eBPF code near any kernel function.</p>
<p>We can find the <code>task_struct</code> related functions in kernel source code,  for example, <a href="https://elixir.bootlin.com/linux/v5.12.13/source/include/linux/sched/task.h#L85">kernel_clone</a> will be called when a new thread is created (<code>do_fork</code> function in old version kernel, kernel code is fickle, please compare the actual version of the source code  to analyze ), and then <code>kernel_clone</code> will return a int pid to represent the new created thread, so we  can use <code>kprobe</code> to see which thread are created by kernel right now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@dev# bpftrace -e <span class="s1">&#39;kretprobe:kernel_clone { printf(&#34;new process created, pid: %d\n&#34;, retval); }&#39;</span>
</span></span><span class="line"><span class="cl">Attaching <span class="m">1</span> probe...
</span></span><span class="line"><span class="cl">new process created, pid: <span class="m">21902</span>
</span></span><span class="line"><span class="cl">new process created, pid: <span class="m">21903</span>
</span></span><span class="line"><span class="cl">new process created, pid: <span class="m">21904</span>
</span></span><span class="line"><span class="cl">new process created, pid: <span class="m">21905</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Meanwhile, it&rsquo;s not hard to find that a function called  <code>copy_process</code>is called inside <code>kernel_clone</code>, which will return a sturct <code>task_struct</code>, so we can observe the familiar object again.</p>
<p>Since we need to import the datastructure inside kernel, so related header files are require to <strong>include</strong> first, which takes more than one line, so we have to create a script file and then pass it to bpftrace to execute:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">root</span><span class="err">@</span><span class="n">dev</span><span class="err">#</span> <span class="n">cat</span> <span class="n">copy_process</span><span class="p">.</span><span class="n">bt</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched/task.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// kretprobe means callback after function call， kprobe is callback before function call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">kretprobe</span><span class="p">:</span><span class="n">copy_process</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="err">$</span><span class="n">task</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">retval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Command: %s PID: %d TGID: %d State: %ld Flags: %d Policy: %d Prio: %d StaticPrio: %d Current CPU: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">static_prio</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>After script executed, we can see the output of these fields:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@dev# bpftrace process_create.bt
</span></span><span class="line"><span class="cl">Attaching <span class="m">1</span> probe...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Command: crond PID: <span class="m">22700</span> TGID: <span class="m">22700</span> State: <span class="m">2048</span> Flags: <span class="m">4194368</span> Policy: <span class="m">0</span> Prio: <span class="m">120</span> StaticPrio: <span class="m">120</span> Current CPU: <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Command: sh PID: <span class="m">22701</span> TGID: <span class="m">22701</span> State: <span class="m">2048</span> Flags: <span class="m">4194368</span> Policy: <span class="m">0</span> Prio: <span class="m">120</span> StaticPrio: <span class="m">120</span> Current CPU: <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Command: sh PID: <span class="m">22702</span> TGID: <span class="m">22702</span> State: <span class="m">2048</span> Flags: <span class="m">4194368</span> Policy: <span class="m">0</span> Prio: <span class="m">120</span> StaticPrio: <span class="m">120</span> Current CPU: <span class="m">1</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><h1 id="summary">Summary</h1>
<p>This article shows two lightweight kernel debug tips: kernel module &amp; eBPF, they can help us to understand the kernel runtime situation, except the process related information mentioned above, it&rsquo;s also very practical in situations like  network diagnosis, kernel stuck, IO cache, suspicious system call and so on.</p>

          </div>

          
          <div class="row">
            <div class="col-md-8">
            
              <div class="mb-5">
                
<div class="li-x div-x post-meta">
  <li class="pr-0"><a href="https://huweicai.com/tags/"><i class="fas fa-tags"></i></a></li>
  <div class="tags-sm">
    
      <li><a href="https://huweicai.com/tags/linux" role="button">linux </a></li>
      
    
      <li><a href="https://huweicai.com/tags/kernel" role="button">kernel </a></li>
      
    
      <li><a href="https://huweicai.com/tags/ebpf" role="button">ebpf </a></li>
      
    
      <li><a href="https://huweicai.com/tags/en" role="button">EN </a></li>
      
    
  </div>
</div>
              </div>
            
            </div>
            
          </div>
          

          
          <div class="row pt-3">
            <div class="col-md-6">
              
                <a href=https://huweicai.com/cubefs-with-kubernetes/ class="post-meta">Previous
                  <div class="pt-2 pb-5 d-flex">
                    <i class="fas fa-angle-left text-grey font-weight-bold mr-2 active-color"></i>
                    <span>CubeFS&amp;Kubernetes实践</span>
                  </div>
                </a>
              
            </div>
            
            <div class="col-md-6 text-right" >
              
                <a href=https://huweicai.com/shared-memory/ class="post-meta">Next
                  <div class="pt-2 pb-5 flex-reverse">
                    <i class="fas fa-angle-right text-grey font-weight-bold ml-2 active-color"></i>
                    <span>很快的共享内存</span>
                  </div>
                </a>
              
            </div>
          </div>

          

        </div>
        

      </div>
      

      
	
	
	
	
		
		
		
	

		
		<div class="col-md-2 pl-0">

			
			<div id="page-scrollspy" class="toc-nav">
				
				<ul class="nav nav-pills ml-0">
					
					<li class="nav-item pb-3 text-center">
						<span class="font-weight-bold mb-2">- CATALOG - </span>
					</li>

					
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#kernel">
												 Kernel
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#kernel-module">
												 Kernel Module
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#ebpf">
												 eBPF
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#ebpf-1">
												 eBPF
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#bpftrace">
												 bpftrace
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#have-a-try">
												 Have a try
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#summary">
												 Summary
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 

				</ul>
			</div>
			

		</div>
		
	

    </div>
    


  </main>
  


    
    

<footer class="page-footer text-center font-small mt-4 wow fadeIn">


  
  <div class="pb-2 mt-5 pt-5">
    
      <a href="//github.com/Huweicai " target="_blank" rel="noopener"><i class="fab fa-github mr-3" aria-hidden="true"></i></a>    
    
    
      <a href="//linkedin.com/in/you" target="_blank" rel="noopener"><i class="fab fa-linkedin-in mr-3" aria-hidden="true"></i></a>
    

    
      <a href="//facebook.com/you" target="_blank" rel="noopener"><i class="fab fa-facebook-f mr-3" aria-hidden="true"></i></a>
    

    
    <a href="//google.com/you" target="_blank" rel="noopener"><i class="fab fa-google-plus-g mr-3" aria-hidden="true"></i></a>
    

    
        <a href="//twitter.com/you" target="_blank" rel="noopener"><i class="fab fa-twitter mr-3" aria-hidden="true"></i></a>
    

    
        <a href="//instagram.com/you" target="_blank" rel="noopener"><i class="fab fa-instagram mr-3" aria-hidden="true"></i></a>
    

    
        <a href="//px500" target="_blank" rel="noopener"><i class="fab fa-500px mr-3" aria-hidden="true"></i></a>
    


    
        <a href="mailto:i@huweicai.com"><i class="far fa-envelope-open mr-3" aria-hidden="true"></i></a>
    

      <a href=""><i class="fas fa-rss mr-3" aria-hidden="true"></i></a>

    

  </div>
  

  
  <div class="copyright py-4">
    
    <span>  2016 - 2024 &copy; <a href="https://huweicai.com/">Huweicai</a>  </span>
  </div>
  

</footer>


    






<script type="text/javascript" src="https://s3.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.js"></script>
<script type="text/javascript" src="https://s3.pstatp.com/cdn/expire-1-M/jquery-smooth-scroll/2.2.0/jquery.smooth-scroll.min.js"></script>



<script type="text/javascript" src="https://s0.pstatp.com/cdn/expire-1-M/popper.js/1.15.0/esm/popper.min.js"></script>
<script type="text/javascript" src="https://s0.pstatp.com/cdn/expire-1-M/popper.js/1.15.0/esm/popper.min.js"></script>
<script type="text/javascript" src="https://s3.pstatp.com/cdn/expire-1-M/twitter-bootstrap/4.1.3/js/bootstrap.js" ></script>

<script type="text/javascript" src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/mdbootstrap/4.9.0/js/mdb.min.js"></script>

<script type="text/javascript" src="https://huweicai.com/js/main.js"></script>




  <script src="https://huweicai.com/js/vendors/highlight.pack.js"> </script>
  <script>hljs.initHighlightingOnLoad();</script>





  <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.13.0/katex.min.js"> </script>
  <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.13.0/contrib/auto-render.min.js"></script>

  <script>
      document.addEventListener("DOMContentLoaded", function () {
          renderMathInElement(document.body);
      });
  </script>








<script type="text/javascript">
  
  new WOW().init();
</script>




  </body>
</html>